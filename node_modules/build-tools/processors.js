var fs = require("fs"),
    path = require("path"),
	pleeease = require('pleeease'),
	color = require('cli-color');


module.exports = {
	// build css
	sass: function(params) {	

		var file = params.file;
		// build output path and filename
		var outFile = params.outputDir + path.basename(file, path.extname(file)) + '.css';
		
		var css = fs.readFileSync(file, 'utf8');
		
		var pleeeaseOptions = {
    		"in": path.resolve(file),
    		"out": path.resolve(outFile),
    		sass: true,
    		"rem": true,
    		"autoprefixer": {"browsers": ['> 3%', 'last 2 versions', 'Firefox ESR', 'Opera 12.1', 'Explorer 9']},
    		"import": true,
            "minifier": true,
            "sourcemaps": {
                "map": { "inline": false },
                "from": path.resolve(file),
                "to": path.resolve(outFile)
            }
		};
		
		// let pleeease do it's job
		var fixed = pleeease.process(css, pleeeaseOptions);
		
		//console.log(fixed);
		
		// save css
		fs.writeFile(outFile, fixed.css, function(err) {
		    if(err) {
		        console.log(color.red('Error saving ' + outFile + ': ' + err));
		    } else {
		        // file saved
		        console.log(color.green('Rendered CSS for '+file + ' to ' +outFile));
		    }
		});
		// save source map
		fs.writeFile(outFile+'.map', fixed.map, function(err) {
		    if(err) {
		        console.log(color.red('Error saving ' + outFile+'.map' + ': ' + err));
		    } else {
		        // file saved
		        console.log(color.green('Saved soure map for '+file + ' to ' +outFile+'.map'));
		    }
		});
					    
	}
	
}